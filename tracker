<script>
    /** ######################## **/
    /* LHM Custom Code PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    // Adjust matomo tracking settings here
    // If you adjust the following params, you have to adjust the src of the image tag above aswell
    const MATOMO_TARGET_ID = '3';
    const MATOMO_BASEPATH = 'https://webstatstest.muenchen.de/';
    const MATOMO_TARGET_PHP = MATOMO_BASEPATH + 'matomo.php';
    const MATOMO_TARGET_JS = MATOMO_BASEPATH + 'matomo.js';
    // the base (first part) of the action identifier
    const CONTENTBASE = 'wilma';

    // use variables for custom dimensions in case they are setup differently in matomo

    const CUSTOMDIMENSION_PAGETYPE = 1
    const CUSTOMDIMENSION_PAGETITLE = 2
    const CUSTOMDIMENSION_APPTYPE = 3
    const CUSTOMDIMENSION_APPTITLE = 4
    const CUSTOMDIMENSION_CONTENTTITLE = 5
    const CUSTOMDIMENSION_PAGETYPE_EVENT = 6
    const CUSTOMDIMENSION_PAGETITLE_EVENT = 7
    const CUSTOMDIMENSION_APPTYPE_EVENT = 8
    const CUSTOMDIMENSION_APPTITLE_EVENT = 9

    // list timeline item tracked users here with profile uri endpoint
    // posts by these users in a timeline wont be tracked (likes,comments,...)
    const EXCLUDE_TIMELINETRACKINGUSERS = []; //'ian-bold', 'robert-lang'
    // do not track at all on these paths
    const EXCLUDED_PATHS = ['/admin']; // '/workspaces/', '/admin/'
    // track, but do not send custom dimensions on these paths
    const EXCLUDED_GROUPINGPATHS = ['/profile', '/account']; // '/workspaces/', '/admin/'
    // dev/test/prod
    const ENV = 'prod';

    const TRACKINGSETTINGS = {
        // if we track documents, skip the default logic and use the doctitle as CUSTOMDIMENSION_CONTENTTITLE instead of PAGETITLE, APPTYPE or APPTITLE
        DOCUMENTTITLE_AS_CONTENT: true,
        // use the tagmanager or inline js code for tracking, tagmanager needs some extra logic which is activated here
        USE_TAGMANAGER: true,
        // clicktracking events on the mainnavigation
        NAV_MAIN: true,
        // clicktracking events on the subnavigation
        NAV_SUB: true,
        // clicktracking events on mobile sidemenu, careful: if the admin area is not excluded by EXCLUDED_PATHS this menu is considered as mobile too!
        NAV_MOBILE: true,
        // clicktracking events on subscriptions (sidebar of homepage)
        SIDEBAR_SUBSCRIPTIONS: true,
        // clicktracking events on bookmarks (sidebar of homepage)
        SIDEBAR_BOOKMARKS: true,
        // searchtracking while typing in the inline searchfield
        SEARCH_INLINE: true,
        // searchtracking on main searchresultpage
        SEARCH_MAIN: true,
        // clicktracking events when clicking on filters at searchresultpage
        SEARCHFILTER: true,
        // eventtracking embedded videos onPlay (currently only coyo-uploaded) 
        VIDEOPLAY: true,
        // eventtracking sending of chat-messages
        CHAT_MESSAGES: true,
        // eventtracking creation of new chat channels
        CHAT_CHANNELS: false,
        // eventtracking creation of all kinds of comments
        COMMENTS: true,
        // eventtracking subscribe/unsubscribe
        SUBSCRIPTIONS: true,
        // eventtracking like/unlike
        LIKES: true,
        // eventtracking change of user status
        USER_STATUS: true,
        // eventtracking file uploads
        MEDIA_UPLOAD: true,
        // eventtracking for downloading files, done by downloadlistener in tracking.js
        MEDIA_DOWNLOAD: true,
        // eventtracking file views (when modal with filedetails opens), for all filetypes including videos
        MEDIA_VIEW: true,
        // eventtracking for shares
        SHARE: true,
        // eventtracking creation of articles (wiki,blog)
        CREATE_ARTICLES: false,
        // eventtracking creation of events
        CREATE_EVENTS: false,
        // eventtracking creation of pages
        CREATE_PAGES: false,
        // eventtracking for new timeline entries
        CREATE_TIMELINE: false,
        // eventtracking if timeline items get deleted
        DELETE_TIMELINE: false,
        // track clicks on links to coyo-external files
        TRACKEXTERNALFILES: true,
    }

    // selectors used by clicktracking
    const SELECTORS = {
        HEAD_NAVIGATION: '.navbar-main .nav-left a',
        HEAD_SUBNAVIGATION: '.navbar-sub a',
        NAV_SIDEBAR: '.sidebar .nav-sidebar-item a',
        SIDEBAR_SUBSCRIPTIONS: 'coyo-subscription-widget a',
        SIDEBAR_BOOKMARKS: 'coyo-bookmarking-show a, .bookmarking-widget a',
        SEARCHFILTER_TYPE: 'coyo-filter[title-key="MODULE.SEARCH.TYPE"] a',
        SEARCHFILTER_MODIFIED: 'coyo-filter[title-key="MODULE.SEARCH.MODIFIED"] a',
        SEARCHFILTER_LOCATION: 'coyo-filter[title-key="MODULE.SEARCH.LOCATION"] a',
        SEARCHFILTER_AUTHOR: 'coyo-filter[title-key="MODULE.SEARCH.AUTHOR"] a',
    }

    // matomo specific tracking settings
    const MATOMOSETTINGS = {
        HEARTBEAT: 5,
        // feature untested: if this is empty the following settings starting with CONTENT_ do nothing, 
        // otherwise its used as selector to send content impressions
        CONTENT_NODE: '', // add valid selector here (e.g. '.content')
        // feature untested: sends trackContentImpressionsWithinNode (standard for single page applications) / trackVisibleContentImpressions
        // if this is empty, no content impressions are tracked
        CONTENT_TRACKING_MODE: '', // valid values: node/delay
        // the delay for sending content impressions if CONTENT_TRACKING_MODE is set to 'delay'
        CONTENT_REFRESHDELAY: 750,
        // feature untested: Mediaanalytics
        CONTENT_SCAN_FOR_MEDIA: true,
        // feature untested: Formanalytics
        CONTENT_SCAN_FOR_FORMS: true,
        // feature untested: clicktracking behavior (https://developer.matomo.org/api-reference/tracking-javascript)
        // false = only left clicks count, 
        // true = opening the contextmenu via middle or right button counts too, even before actually leaving the page
        MIDDLERIGHT_MOUSECLICK: true,
        // short delay for internal use doing async things... 
        DELAY_FOR_STATECHANGE: 10,
        // domainfilter that tells matomo to store trackingdata only when sent via these domains (typically just the own/current domain) 
        DOMAINS: [location.hostname],
    }

    /** ######################## **/
    /* LHM Tracking DB Helper PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    var coyoTrackingDBHelper = {
        objects: {},
        acceptedUrlPatterns: [
            // if this is empty, all requests are analyzed
            // { 'get': /\/blog\/articles/g },
            // { 'get': /\/wiki\/articles/g },
            // { 'get': /\/web\/pages/g },
            // { 'get': /\/web\/workspaces/g },
            // { 'get': /\/web\/timeline-items/g },
            // { 'get': /\/web\/comments/g },
            // { 'get': /\/web\/users/g },
            // { 'post': /\/web\/comments/g }
        ],

        isAcceptedURL: function(url, method) {
            if (!url || !method) return false;
            return (this.acceptedUrlPatterns.length == 0) || this.acceptedUrlPatterns.some(function(pattern) {
                return pattern[method.toLowerCase()] && url.match(pattern[method.toLowerCase()]);
            });
        },

        buildAuthorMessage: function(message, authorItem) {
            message = message || '';
            message = message.length > 30 ? message.substring(0, 30).trim() + ' ...' : message;
            return authorItem ? authorItem.slug + ' >> ' + message : message;
        },

        stripHTML: function(html) {
            if (!html) return '';
            var doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || '';
        },

        buildTrackingTitle: function(item, parent) {
            if (!item) return '';
            var title = item.displayName || '';
            if (item.typeName == 'timeline-item') {
                var message = (item.data ? item.data.message : this.stripHTML(item.excerpt)) || '';
                title = this.buildAuthorMessage(message, item.author);
            } else if (item.typeName == 'comment') {
                var message = item.message || (item.data ? item.data.message : '');
                title = this.buildAuthorMessage(message, item.author);
            } else if ('user' == item.typeName) {
                title = item.slug;
            }

            return title;
        },

        checkStorageForData: function(method, responseHeader) {
            if (!responseHeader) {
                return null;
            }
            try {
                var cache = $.extend(JSON.parse(sessionStorage['ngStorage-etagBulkCache'] || null), JSON.parse(sessionStorage['coyo-etagBulkCache'] || null));
                var keys = Object.keys(cache);
                var itemID = (/"([0-9a-fA-F-]*)":/g).exec(responseHeader)[1];
                var etag = (/:"([0-9a-fA-F-]*)"/g).exec(responseHeader)[1];
                for (var i = 0; i < keys.length; i++) {
                    var item = cache[keys[i]][itemID];
                    if (this.isAcceptedURL(keys[i], method) && item && item.etag == etag) {
                        return item.data || item.body;
                    }
                };
            } catch (e) {}
            return null;
        },

        processParent: function(item) {
            // process parents of shared content 
            if (item.typeName == 'timeline-item' && item.data) {
                // shared or native timeline-item
                if (item.itemType == 'post' && item.recipients && item.recipients.length == 1) {
                    var target = item.recipients[0];
                    return {
                        id: target.id,
                        type: target.typeName,
                        name: this.buildTrackingTitle(target)
                    };
                }
                // shared content item
                for (var temp in item.data) {
                    if (item.data[temp] && item.data[temp].sender) {
                        this.setObjectData(item.data[temp].sender);
                        var object = {
                            id: item.data[temp].id,
                            parent: {
                                id: item.data[temp].sender.id,
                                typeName: item.data[temp].sender.typeName,
                                name: this.buildTrackingTitle(item.data[temp].sender)
                            }
                        }
                        this.setObjectData(object);
                    }
                }
            } else if (item.typeName == 'wiki-article' || item.typeName == 'blog-article') {
                var parent = this.objects[item.senderId];
                if (parent) {
                    return {
                        id: item.senderId,
                        type: parent.type,
                        name: parent.name
                    };
                }
            } else if (item.typeName == 'comment' && item.target) {
                var parent = this.objects[item.target.id];
                if (parent) {
                    return {
                        id: item.target.id,
                        type: parent.type,
                        name: parent.name
                    };
                }
            }
            return null;
        },

        setObjectData: function(item, nameOverride) {
            if (!item || !item.id) return;

            var recipient = item.recipients && item.recipients.length == 1 ? item.recipients[0] : null;
            var parent = this.processParent(item);

            // override old values if new ones are present
            var id = item.id;
            this.objects[id] = this.objects[id] || {
                name: '',
                type: '',
                target: {
                    id: '',
                    type: ''
                },
                author: '',
                parent: {
                    id: '',
                    type: '',
                    name: ''
                }
            };
            this.objects[id].type = item.typeName || this.objects[id].type;
            this.objects[id].target.id = recipient ? recipient.id : this.objects[id].target.id;
            this.objects[id].target.type = (recipient ? recipient.typeName : '') || this.objects[id].target.type;
            this.objects[id].author = (item.author ? item.author.slug : '') || this.objects[id].author;
            this.objects[id].parent.id = (parent ? parent.id : item.parent ? item.parent.id : '') || this.objects[id].parent.id;
            this.objects[id].parent.type = (parent ? parent.typeName : item.parent ? item.parent.typeName : '') || this.objects[id].parent.type;
            this.objects[id].parent.name = (parent ? parent.name : item.parent ? item.parent.name : '') || this.objects[id].parent.name;

            // this has to be last call because there may be dependencies to the objects parent when generating the name
            this.objects[id].name = nameOverride ? nameOverride : (this.buildTrackingTitle(item, this.objects[id].parent) || this.objects[id].name);
        },

        getObjectData: function(id) {
            return this.objects[id] || {
                name: '',
                type: '',
                target: {
                    id: '',
                    type: ''
                },
                author: '',
                parent: {
                    id: '',
                    type: '',
                    name: ''
                }
            };
        },

        populateContentData: function(content) {
            var that = this;
            if (!content || !Array.isArray(content)) return;
            content.forEach(function(item) {
                that.setObjectData(item);
            });
        },

        populateResponseData: function(response, responseURL, method) {
            if (typeof response == 'undefined' || !response || typeof response != 'object' || !this.isAcceptedURL(responseURL, method)) return;
            var that = this;
            if (response.topApps) {
                response.topApps.forEach(function(item) {
                    that.setObjectData(item, item.slug);
                });
            }
            if (response.id) {
                this.setObjectData(response);
            }

            if (response.content) {
                this.populateContentData(response.content);
            } else {
                for (var item in response) {
                    if (response[item] && response[item].content) {
                        this.populateContentData(response[item].content);
                    }
                }
            }
        },
    };

    var openPrototypeDB = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function() {
        var method = arguments[0];
        var reqURL = arguments[1];
        this.addEventListener('load', function() {
            var resp = {};
            resp.responseType = this.responseType;
            resp.responseURL = this.responseURL || reqURL;
            try {
                resp.responseText = this.responseText;
                resp.responseHeader = this.getResponseHeader('x-bulk-etag');
            } catch (e) {}
            setTimeout(function() {
                var response;
                try {
                    if ((resp.responseType == '' || resp.responseType == 'text' || resp.responseType == 'document' || resp.responseType == 'moz-chunked-text') && resp.responseText) {
                        response = eval("(" + resp.responseText + ")");
                    }
                } catch (e) {}

                if ($.isEmptyObject(response) && coyoTrackingDBHelper.isAcceptedURL(resp.responseURL, method)) {
                    response = coyoTrackingDBHelper.checkStorageForData(method, resp.responseHeader);
                }

                coyoTrackingDBHelper.populateResponseData(response, resp.responseURL, method);
            });
        }, 2);
        openPrototypeDB.apply(this, arguments);
    };

    /** ######################## **/
    /* LHM Tracking Utils PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    var coyoTrackingUtils = {
        OVERRIDES: {
            TYPE: {},
            PAGEID: {}
        },
        FILEEXTENSIONS: ['7z', 'aac', 'apk', 'arc', 'arj', 'asf', 'asx', 'avi', 'azw3', 'bin', 'csv', 'deb', 'dmg', 'doc', 'docx',
            'epub', 'exe', 'flv', 'gif', 'gz', 'gzip', 'hqx', 'ibooks', 'jar', 'jpg', 'jpeg', 'js', 'mobi', 'mp2', 'mp3', 'mp4', 'mpg',
            'mpeg', 'mov', 'movie', 'msi', 'msp', 'odb', 'odf', 'odg', 'ods', 'odt', 'ogg', 'ogv', 'pdf', 'phps', 'png', 'ppt', 'pptx',
            'qt', 'qtm', 'ra', 'ram', 'rar', 'rpm', 'sea', 'sit', 'tar', 'tbz', 'tbz2', 'bz', 'bz2', 'tgz', 'torrent', 'txt', 'wav', 'wma',
            'wmv', 'wpd', 'xls', 'xlsx', 'xml', 'z', 'zip'
        ],
        _openRequests: 0,
        _currentUrl: location.href,
        _initialStateChangeFired: false,
        _pendingSearch: 0,
        _lastFileId: '',
        createHashCode: function(input) {
            var hash = 0,
                i, chr;
            if (!input || input.length === 0) return hash;
            for (i = 0; i < input.length; i++) {
                chr = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0;
            }
            return hash;
        },
        getUserIdHash: function() {
            return '' + coyoTrackingUtils.createHashCode(localStorage.getItem('ngStorage-userId'));
        },
        cleanupCustomDimensions: function() {
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_CONTENTTITLE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT]);
            //VISIT TEST
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_CONTENTTITLE_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT_VISIT]);
            // _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT_VISIT]);
        },
        excludeUrl: function(url, pathArray) {
            var paths = pathArray || EXCLUDED_PATHS;
            return paths && paths.some(function(path) {
                var regex = new RegExp(path.replace('/', '\\/') + '(?=$|\\/|\\?)', 'gi')
                return url && url.match(regex);
            });
        },
        excludeUser: function(item) {
            var user = '';
            if (!item || !item.type) return false;

            switch (item.type) {
                case 'timeline-item':
                    user = item.author;
                    break;
                case 'user':
                    user = item.name;
                    break;
                default:
                    return false;
            }

            return EXCLUDE_TIMELINETRACKINGUSERS && EXCLUDE_TIMELINETRACKINGUSERS.some(function(item) {
                return item == user;
            });
        },
        excludeFromTracking: function(pathArray) {
            // check container of a file within the preview modal
            var fileOriginElem = document.querySelector('coyo-library-file-details .coyo-file-details dt[translate="FILE_DETAILS.FILE_ORIGIN"]');
            if (fileOriginElem) {
                try {
                    var linkElem = fileOriginElem.nextElementSibling.getElementsByTagName('a')[0];
                    var url = linkElem ? linkElem.href : null;
                    if (coyoTrackingUtils.excludeUrl(url, pathArray)) {
                        return true;
                    }
                } catch (e) {}
            }
            return coyoTrackingUtils.excludeUrl(location.href, pathArray) || coyoTrackingUtils.preventTracking;
        },
        typeNameOverrides: function(typeName, escape) {
            escape = (typeof escape === 'boolean' && escape) ? true : false;
            typeName = coyoTrackingUtils.OVERRIDES.TYPE[typeName.toLowerCase().trim()] || typeName;
            if (typeName && typeName.length) typeName = typeName.charAt(0).toUpperCase() + typeName.slice(1);
            if (escape) typeName = encodeURIComponent(coyoTrackingUtils.shortenString(typeName, 200));
            typeName = coyoTrackingUtils.cleanUnicodeIcons(typeName).text;
            return typeName;
        },
        typeNameOverridesPageId: function(typeName) {
            return coyoTrackingUtils.OVERRIDES.PAGEID[typeName] || typeName;
        },
        translateText: function(text) {
            return text && text.toLowerCase()
                .replace(/[\/\ \.]/g, '-')
                .replace(/\u00dc/g, 'Ue')
                .replace(/\u00fc/g, 'ue')
                .replace(/\u00c4/g, 'Ae')
                .replace(/\u00e4/g, 'ae')
                .replace(/\u00e4/g, 'ae')
                .replace(/\u00d6/g, 'Oe')
                .replace(/\u00f6/g, 'oe')
                .replace(/\u00df/g, 'ss')
                .replace(/_/g, '-')
                .replace(/(?:\r\n|\r|\n)/g, '-')
                .replace(/&/g, ' und ')
                .replace(/@/g, ' -at- ')
                .replace(/[^a-zA-Z0-9 \-\\.\/]+/g, '') //remove . after text inside a title to avoid confusion with . as separator
                .replace(/\s+/g, '-')
                .replace(/[-]{2,}/g, '-')
                .replace(/^-*/g, '') //remove all trailing '-' so we dont get '-my-shiny-title-'
                .replace(/-*$/g, '') || '';
        },
        shortenString: function(input, maxlength) {
            maxlength = maxlength || 30;
            return input.length > maxlength ? input.substring(0, maxlength).trim() + '...' : input;
        },
        parseQueryString: function(str) {
            var query = (str || '?').substr(1);
            var map = {};
            query.replace(/([^&=]+)=?([^&]*)(?:&+|$)/g, function(match, key, value) {
                (map[key] = map[key] || []).push(value);
            });
            return map;
        },
        getAngularComponent: function(domElem) {
            try {
                return angular.element(domElem).data().$$$angularInjectorController.view.nodes[0].componentView.component;
            } catch (e) {
                console.debug(e);
                return null;
            }
        },
        /* handleAppTypeExceptions
         * we check the class for an appname (because the url is unreliabe)
         * to fix things like blog-list-view to "blog", we cut this class at the first '-', but there are exceptions from that rule which are handled here
         */
        handleAppTypeExceptions: function(classMatch) {
            var split = classMatch.split('-');
            if (split.length > 1 && split[1].length > 0) {
                switch (split[0]) {
                    case 'members':
                        return (['list', 'invited', 'requested'].indexOf(split[1]) !== -1) ? split[0] + '-' + split[1] : split[0];
                    case 'file':
                        return (['library'].indexOf(split[1]) !== -1) ? split[0] + '-' + split[1] : split[0];
                    case 'blog':
                        return (['article'].indexOf(split[1]) !== -1) ? split[0] + '-' + split[1] : split[0];
                    case 'wiki':
                        return (['article'].indexOf(split[1]) !== -1) ? split[0] + '-' + split[1] : split[0];
                    case 'chat':
                        return (['message'].indexOf(split[1]) !== -1) ? split[0] + '-' + split[1] : split[0];
                    case 'timeline':
                        return (['item'].indexOf(split[1]) !== -1) ? split[0] + '-' + split[1] : split[0];
                    default:
                        return split[0]
                }
            }
            return split[0];
        },
        getPageConfig: function(override) {
            var contentGroup = [CONTENTBASE];
            var trackingTitle = '';
            override = override || {};

            var analyzePage = function(contentGroup, override) {
                var splitUrl = window.location.href.split('/');
                var page = $('section.page div.panel.panel-default div.panel-foreground div.titles-container div.title-description-wrapper div.title').text().trim() || (splitUrl[4] ? decodeURIComponent(splitUrl[4]) : null);
                var navigation = $('section.page .content-sidebar .panel-navigation ul.nav.nav-default li.filter-entry.active a').text().trim() || coyoTrackingDBHelper.getObjectData(splitUrl[7]).name;
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-page-show-apps-([\w\-]*)/g.exec(bodyClass) || /state-main-page-show-([\w\-]*)/g.exec(bodyClass) || /state-main-page-([\w\-]*)/g.exec(bodyClass);
                if (ENV !== 'prod') console.log('analyzePage', bodyClass, classMatch);
                if (classMatch && classMatch[1]) {
                    // see comments on function for more info
                    var app = coyoTrackingUtils.handleAppTypeExceptions(classMatch[1]);
                } else if (splitUrl[6]) {
                    // handle anything that is not an app by prepending the type like members_invited
                    var app = splitUrl[5] && splitUrl[5] !== 'apps' ? decodeURIComponent(splitUrl[5] + '-' + splitUrl[6]) : decodeURIComponent(splitUrl[6]);
                }
                // check for platform specific type name overrides
                contentGroup[1] = 'pages';
                if (page) contentGroup[2] = override[2] ? override[2] : page;
                if (app && 'create' !== app.toLowerCase()) contentGroup[3] = override[3] ? override[3] : app;
                if (navigation) contentGroup[4] = override[4] ? override[4] : navigation;
            };

            var analyzeWorkspace = function(contentGroup, override) {
                var splitUrl = window.location.href.split('/');
                var workspace = $('section.workspace div.panel.panel-default div.panel-foreground div.titles-container div.title').text().trim() || (splitUrl[4] ? decodeURIComponent(splitUrl[4]) : null);
                var navigation = $('section.workspace .content-sidebar .panel-navigation ul.nav.nav-default li.filter-entry.active a').text().trim() || coyoTrackingDBHelper.getObjectData(splitUrl[7]).name;
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-workspace-show-apps-([\w\-]*)/g.exec(bodyClass) || /state-main-workspace-show-([\w\-]*)/g.exec(bodyClass) || /state-main-workspace-([\w\-]*)/g.exec(bodyClass);
                if (ENV !== 'prod') console.log('analyzeWorkspace', bodyClass, classMatch);
                if (classMatch && classMatch[1]) {
                    // see comments on function for more info
                    var app = coyoTrackingUtils.handleAppTypeExceptions(classMatch[1]);
                } else if (splitUrl[6]) {
                    // handle anything that is not an app by prepending the type like members_invited
                    var app = splitUrl[5] && splitUrl[5] !== 'apps' ? decodeURIComponent(splitUrl[5] + '-' + splitUrl[6]) : decodeURIComponent(splitUrl[6]);
                }
                // check for platform specific type name overrides
                contentGroup[1] = 'workspaces';
                if (workspace) contentGroup[2] = override[2] ? override[2] : workspace;
                if (app && 'create' !== app.toLowerCase()) contentGroup[3] = override[3] ? override[3] : app;
                if (navigation) contentGroup[4] = override[4] ? override[4] : navigation;
            };

            var analyzeEvent = function(contentGroup, override) {
                var splitUrl = window.location.href.split('/');
                var event = $('section.event div.panel.panel-default div.titles-container div.title').text().trim() || (splitUrl[4] ? decodeURIComponent(splitUrl[4]) : null);
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-event-show-([\w\-]*)/g.exec(bodyClass) || /state-main-event-([\w\-]*)/g.exec(bodyClass);
                if (ENV !== 'prod') console.log('analyzeEvent', bodyClass, classMatch);
                if (classMatch && classMatch[1]) {
                    // see comments on function for more info
                    var app = coyoTrackingUtils.handleAppTypeExceptions(classMatch[1]);
                } else if (splitUrl[6]) {
                    // handle anything that is not an app by prepending the type like members_invited
                    var app = splitUrl[5] && splitUrl[5] !== 'apps' ? decodeURIComponent(splitUrl[5] + '-' + splitUrl[6]) : decodeURIComponent(splitUrl[6]);
                }
                // check for platform specific type name overrides
                contentGroup[1] = 'events';
                if (event) contentGroup[2] = override[2] ? override[2] : event;
                if (app && 'create' !== app.toLowerCase()) contentGroup[3] = override[3] ? override[3] : app;
            };

            var analyzeContentTitle = function(contentGroup, override) {
                // check if the user is creating or editing sth
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-(page|workspace|event)-show-apps-([\w\-]*)/g.exec(bodyClass) ||
                    /state-main-(page|workspace|event)-show-([\w\-]*)/g.exec(bodyClass) ||
                    /state-main-(page|workspace|event)-([\w\-]*)/g.exec(bodyClass);
                var func = classMatch ? /-(create|edit)$/g.exec(classMatch[2]) : null;
                func = func ? func[1] : null;

                // cloning and stuff is needed to remove the status text from title string (open, closed, etc.)
                var threadTitle = $('.thread-view .thread-title').clone().children().remove().end().text().trim();
                // since is possible that there are multiple article titles on a page, we have to priorize them with the following statement
                var articleTitleElem = $($('.article-view .panel-title-main:first')[0] || $('.article-view .panel-title:first')[0] || $('.article-view .article-title:first')[0]);
                var articleTitle = articleTitleElem.text().trim();

                try {
                    // this can cause errors for MEDIA UPLOAD event, when uploading files while editing/creating articles
                    // but as we dont need the contenttitle for events, we just ignore them
                    console.log('func:', func, ' / articleTitleElem: ', articleTitleElem, ' / title: ', articleTitle, ' / form: ', $('form input[id*="title"]'));
                    if (func && !articleTitle) {
                        // the following line seems to be the cause, but I was unable to reproduce it
                        // articleTitle = $('form input[id*="title"]').val().trim();
                        var articleFormElem = $('form input[id*="title"]');
                        if (articleFormElem) articleTitle = articleFormElem.val().trim();
                    }

                    var title = articleTitle || threadTitle;
                    if (title) {
                        contentGroup[contentGroup.length] = override[contentGroup.length] ? override[contentGroup.length] : title;
                        // trackingTitle = title + ':' + (contentGroup[2] || '');
                    }
                    // add 'create' or 'edit' behind the content or app title
                    if (func) {
                        contentGroup[contentGroup.length] = override[contentGroup.length] ? override[contentGroup.length] : func;
                    }
                } catch (e) {
                    console.warn(e);
                }
            }

            var analyzeFile = function(contentGroup, override) {
                var splitUrl = window.location.href.split('/');
                contentGroup[1] = 'filelibrary';
                if (splitUrl[5]) {
                    var fileObj = coyoTrackingDBHelper.getObjectData(splitUrl[5]);
                    // check for platform specific type name overrides
                    contentGroup[2] = override[2] ? override[2] : fileObj.name;
                }
            };

            // find the first navigation level
            var navItem = $('nav.navbar-main ul.nav li.nav-item.active a');
            if (!navItem.length) {
                navItem = $('div.sub-navigation nav.navbar ul.nav li.nav-item.active a.nav-item');
            }
            if (navItem.length && navItem.attr('href')) {
                var menuEntry = (/\/([^?\/]*)/g).exec(navItem.attr('href'));
                if (menuEntry && menuEntry.length > 1) {
                    contentGroup[1] = override[1] ? override[1] : menuEntry[1];
                }
            } else if ($('div.content section.profile').length) {
                contentGroup[1] = override[1] ? override[1] : 'profile';
            } else {
                // get the current position generically from body class
                var classMatch = (/state-main-([\w-]*)/g).exec($('body:eq(0)').attr('class'));
                if (classMatch && classMatch.length > 1) {
                    var pageType = classMatch[1].split('-')[0];
                    if (['page', 'workspace', 'event'].indexOf(pageType) !== -1) pageType += 's';
                    contentGroup[1] = override[1] ? override[1] : pageType;
                } else if ((/state-admin/g).exec($('body:eq(0)').attr('class'))) {
                    contentGroup[1] = override[1] ? override[1] : 'admin';
                }
            }

            var contentGroupTwo = {
                'home': function() {
                    var homepage = (/\/[^\/]*\/([^?\/]*)/g).exec(navItem.attr('href'));
                    if (homepage.length > 1) {
                        contentGroup[2] = override[2] ? override[2] : homepage[1];
                    }
                },
                'pages': function() {
                    analyzePage(contentGroup, override);
                    analyzeContentTitle(contentGroup, override);
                },
                'workspaces': function() {
                    analyzeWorkspace(contentGroup, override);
                    analyzeContentTitle(contentGroup, override);
                },
                'events': function() {
                    analyzeEvent(contentGroup, override);
                },
                'profile': function() {
                    var name = $('section.profile div.panel.panel-default div.titles-container div.title').text();
                    var view = $('section.profile div.panel.panel-default div.profile-nav ul.nav li.nav-item.active').attr('href');
                    if (view && view.split('/').length > 3) {
                        contentGroup[3] = override[3] ? override[3] : view.split('/')[3];
                    }
                    contentGroup[2] = override[2] ? override[2] : name;
                },
                'timeline-item': function() {
                    var itemMatch = /\/timeline\/item\/([0-9a-fA-F-]*)/g.exec(window.location.href);
                    if (itemMatch) {
                        contentGroup[2] = override[2] ? override[2] : coyoTrackingDBHelper.getObjectData(itemMatch[1]).name;
                    }
                },
                'fileLibrary': function() {
                    analyzeFile(contentGroup, override);
                }
            };

            //remove anchor tag from pageType
            if (contentGroup[1] && contentGroup[1].indexOf('#') !== -1) {
                contentGroup[1] = contentGroup[1].substr(0, contentGroup[1].indexOf('#'));
            }

            if (contentGroupTwo[contentGroup[1]]) {
                contentGroupTwo[contentGroup[1]]();
            }

            return {
                contentGroup: contentGroup,
                trackingTitle: trackingTitle
            };
        },
        pageIdToString: function(page) {
            var result = "";
            if (page) {
                for (i = 0; i < 100; i++) {
                    if (page[i]) {
                        result += (i > 0 ? "." : "");
                        if (i > 4 && i === page.length - 1) {
                            result += coyoTrackingUtils.shortenString(coyoTrackingUtils.typeNameOverridesPageId(coyoTrackingUtils.translateText(page[i])));
                        } else {
                            result += coyoTrackingUtils.typeNameOverridesPageId(coyoTrackingUtils.translateText(page[i]));
                        }
                    } else {
                        break;
                    }
                }
            }
            return result;
        },
        getResponseHeaders: function(respObj, log) {
            var headers = respObj.getAllResponseHeaders().split(/\r\n/);
            var headersFormatted = {};
            if (log) console.group();
            for (i = 0; i < headers.length; i++) {
                var item = headers[i].split(': ');
                var name = item[0];
                var value = item[1]
                headersFormatted[name] = value;
                if (log) console.debug('getVideoInfo: ', item, name, value);
            }
            if (log) console.groupEnd();
            return headersFormatted;
        },
        getVideoInfo: function(url, callback) {
            var docMatch = (/documents\/([0-9a-fA-F-]*)/g).exec(url);
            var objData = coyoTrackingDBHelper.getObjectData(docMatch[1]);
            console.debug('getVideoInfo: objData lookup: ', objData);
            if (objData && objData.name && objData.name.length) {} else {
                console.debug('getVideoInfo: send HEAD Request');
                var http = new XMLHttpRequest();
                http.open('HEAD', url);
                http.onreadystatechange = function() {
                    console.debug('getVideoInfo: got HEAD StateChange', this);
                    if (this.readyState == this.DONE) {
                        var respHeader = coyoTrackingUtils.getResponseHeaders(this, true);
                        console.debug('getVideoInfo: DATA ', this, coyoTrackingUtils.getResponseHeaders(this));
                        var filename = respHeader['content-disposition'] && respHeader['content-disposition'].match(/filename=\".*(?=")/g)[0].replace('filename="', '');
                        console.debug('getVideoInfo: Header: ', respHeader);
                        console.debug('getVideoInfo: filename', filename);
                        if (filename) callback(filename);
                    }
                };
                http.send();
            }
        },
        onContentReady: function(callback) {
            var check = setInterval(function() {
                if (ENV !== 'prod') console.debug('checking...', body.className)
                if (document.body.className.match(/state(\-\w+)+-\w+/, 'gi')) {
                    clearInterval(check);
                    callback();
                }
            }, 500);
            //fallback: clear after 30s
            setTimeout(function() {
                clearInterval(check);
            }, 30000);
        },
        // onContentReady: function(callback) {
        //     // idea: increment _openRequests for outgoing xhr requests, decrement for each finished request
        //     // check periodically if there are no open requests (_openRequests = 0), 
        //     // if the check is true at least 2 times in a row (because sometimes loaded components execute more following requests),
        //     // execute our tracking
        //     var that = this;
        //     that.counter = 0;
        //     that.initialVal = coyoTrackingUtils._openRequests;
        //     that.executed = false;
        //     var check = setInterval(function(){
        //         if(ENV !== 'prod') console.debug('checking...',coyoTrackingUtils._openRequests)
        //         if(coyoTrackingUtils._openRequests === that.initialVal){
        //             that.counter++;
        //             if(ENV !== 'prod') console.debug('finished? ',that.counter);
        //             if(that.counter >= 1) {
        //                 clearInterval(check);
        //                 that.executed = true;
        //                 callback();
        //             }
        //         } else {
        //             that.counter = Math.max(0,that.counter-1);
        //         }
        //     },500);
        //     // fallback: clear after 5s (usually statechange event + 5s)
        //     setTimeout(function(){
        //         if(!that.executed) {
        //             clearInterval(check);
        //             callback();
        //         }
        //     },5000);
        // },
        cleanUnicodeIcons: function(text) {
            var matched = false;
            var cleantext = text.replace(/[^\u0000-~\u0080-þĀ-žƀ-Ɏ֊־؋৲-৳૱௹฿៛᠆Ḁ-Ỿ\u2000-\u206e₠-₵∀-⋾Ⱡ-\u2c7e⸗⸚〜〰゠꜠-ꟾ﷼︱-︲﹘﹣﹩＄－￠-￡￥-￦]/g, function(match, offset) {
                matched = true;
                return '';
            });
            return {
                matched: matched,
                text: cleantext
            };
        }
    };

    /** ######################## **/
    /* LHM Click Tracking PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    //click event tracking
    var coyoClickTracking = {
        objects: {},
        init: function() {
            coyoClickTracking.ignore = 'data-piwikignore';
            coyoClickTracking.ignoreSelector = ':not([' + coyoClickTracking.ignore + ']';
            coyoUrl = window.location.protocol + '//' + window.location.hostname;
            if (TRACKINGSETTINGS.TRACKEXTERNALFILES) {
                coyoClickTracking.FILELINKSELECTOR = 'a[target="_blank"][href^="' + coyoUrl + '/files"]:not([' + coyoClickTracking.ignore + '-extfile]),';
                for (var i = 0; i < coyoTrackingUtils.FILEEXTENSIONS.length; i++) {
                    coyoClickTracking.FILELINKSELECTOR += 'a[href$=".' + coyoTrackingUtils.FILEEXTENSIONS[i] + '"]' + ':not([' + coyoClickTracking.ignore + '-extfile]):not([href^="/"]):not([href^="' + coyoUrl + '"])';
                    if (i !== coyoTrackingUtils.FILEEXTENSIONS.length - 1) coyoClickTracking.FILELINKSELECTOR += ', ';
                }
            }
        },
        filterClickTracking: function(category, item) {
            item.addEventListener('click', function() {
                var name = "";
                item.querySelectorAll('span:not(.badge)').forEach(function(item) {
                    name += item.textContent;
                });
                name = name.trim();
                var hasResults = item.querySelector('span.badge') !== null;
                sendTrackingEvent(category, coyoTrackingUtils.typeNameOverrides('Click'), coyoTrackingUtils.typeNameOverrides(name), null, hasResults);
            });
            item.setAttribute("data-clickevent", "true");
        },

        // the attribute data-title is set by listening to the stream HEAD request in tracking.js
        // if there is no such attribute, this failed because it was not possible to parse a title or match the response with an element
        addVideoTracking: function() {
            document.querySelectorAll('video' + coyoClickTracking.ignoreSelector).forEach(function(item) {
                console.debug('found video:', item);
                // if a default uploaded video is embedded in a post, there is no information about the title
                // look into objectDB, otherwise send a HEAD request to the source, parse the title from the header, add the data-title attribute to that video
                // then track it with its title on first play
                item.setAttribute(coyoClickTracking.ignore, "true");
                if (!item.getAttribute('data-title')) {
                    console.debug('no title found, try to get it...');
                    coyoTrackingUtils.getVideoInfo(item.src, function(filename) {
                        item.setAttribute('data-title', filename);
                    });
                }
                item.addEventListener('play', function(e) {
                    var viewed = item.getAttribute('data-viewed');
                    //only track initial video starts
                    console.debug('video play triggered, viewed: ' + viewed);
                    if (!viewed) {
                        setTimeout(function() {
                            var title = item.getAttribute('data-title');
                            var modal = document.querySelector('.modal-dialog');
                            console.debug('title: ' + title + '\t/\tmodal: ' + (modal && modal.length > 0));
                            if (title && !modal) sendTrackingEvent('Media', coyoTrackingUtils.typeNameOverrides('View'), title, null);
                            item.setAttribute('data-viewed', "true");
                        }, 500);
                    }
                });
                item.setAttribute(coyoClickTracking.ignore, "true");
            });
        },

        addClickBindings: function() {
            /* update selector object for debugging */
            coyoClickTracking.objects = {};
            for (i = 0; i < Object.keys(SELECTORS).length; i++) {
                var key = Object.keys(SELECTORS)[i];
                var value = SELECTORS[key];
                coyoClickTracking.objects[key] = document.querySelectorAll(value);
            }
            // Header Navigation
            if (TRACKINGSETTINGS.NAV_MAIN) {
                document.querySelectorAll(SELECTORS.HEAD_NAVIGATION + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    // skip mobile menu button
                    if (item.getAttribute('ng-click') === '$ctrl.openMenu()') return true
                    item.addEventListener('click', function(e) {
                        var name = 'Navigation';
                        name = item.className === 'nav-item-brand' ? 'Home' : item.querySelector('.nav-item-label').textContent.trim();
                        sendTrackingEvent('Header', coyoTrackingUtils.typeNameOverrides('Click'), coyoTrackingUtils.typeNameOverrides(name), null);
                    });
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
            }
            // Header Subnavigation
            if (TRACKINGSETTINGS.NAV_SUB) {
                document.querySelectorAll(SELECTORS.HEAD_SUBNAVIGATION + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    item.addEventListener('click', function(e) {
                        var name = 'Navigation';
                        name = item.textContent.trim();
                        sendTrackingEvent('Navi-Top', coyoTrackingUtils.typeNameOverrides('Click'), coyoTrackingUtils.typeNameOverrides(name), null);
                    });
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
            }
            // Mobile Sidebar Navigation
            if (TRACKINGSETTINGS.NAV_MOBILE) {
                document.querySelectorAll(SELECTORS.NAV_SIDEBAR + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    item.addEventListener('click', function(e) {
                        if (coyoTrackingUtils.excludeUrl(window.location.href)) return;
                        var name = 'Navigation';
                        name = item.textContent.trim();
                        sendTrackingEvent('Navi-Mobile', coyoTrackingUtils.typeNameOverrides('Click'), coyoTrackingUtils.typeNameOverrides(name), null);
                    });
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
            }
            if (TRACKINGSETTINGS.SIDEBAR_SUBSCRIPTIONS) {
                document.querySelectorAll(SELECTORS.SIDEBAR_SUBSCRIPTIONS + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    item.addEventListener('click', function() {
                        var type = /\/pages\//gi.exec(item.href) ? 'widget-my-pages' : 'widget-my-workspaces';
                        var name = item.querySelector('span').textContent.trim();
                        sendTrackingEvent(type, coyoTrackingUtils.typeNameOverrides('Click'), coyoTrackingUtils.typeNameOverrides(name), null);
                    });
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
            }
            if (TRACKINGSETTINGS.SIDEBAR_BOOKMARKS) {
                document.querySelectorAll(SELECTORS.SIDEBAR_BOOKMARKS + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    item.addEventListener('click', function(e) {
                        var name = item.textContent.trim();
                        sendTrackingEvent('widget-bookmarks', coyoTrackingUtils.typeNameOverrides('Click'), coyoTrackingUtils.typeNameOverrides(name), null);
                    });
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
            }
            if (TRACKINGSETTINGS.SEARCHFILTER) {
                document.querySelectorAll(SELECTORS.SEARCHFILTER_TYPE + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    coyoClickTracking.filterClickTracking(coyoTrackingUtils.typeNameOverrides('Search-Type'), item);
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
                document.querySelectorAll(SELECTORS.SEARCHFILTER_MODIFIED + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    coyoClickTracking.filterClickTracking(coyoTrackingUtils.typeNameOverrides('Search-Modified'), item);
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
                document.querySelectorAll(SELECTORS.SEARCHFILTER_LOCATION + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    coyoClickTracking.filterClickTracking(coyoTrackingUtils.typeNameOverrides('Search-Location'), item);
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
                document.querySelectorAll(SELECTORS.SEARCHFILTER_AUTHOR + coyoClickTracking.ignoreSelector).forEach(function(item) {
                    coyoClickTracking.filterClickTracking(coyoTrackingUtils.typeNameOverrides('Search-Author'), item);
                    item.setAttribute(coyoClickTracking.ignore, "true");
                });
            }
            if (TRACKINGSETTINGS.TRACKEXTERNALFILES) {
                document.querySelectorAll(coyoClickTracking.FILELINKSELECTOR).forEach(function(item) {
                    item.setAttribute(coyoClickTracking.ignore + '-extfile', "true");
                    item.addEventListener('click', function(e) {
                        var title = coyoTrackingUtils.shortenString(item.textContent, 200)
                        sendTrackingEvent('Media', coyoTrackingUtils.typeNameOverrides('View'), title, null);
                    });
                });
            }
        }
    }

    coyoClickTracking.init();

    // page view tracking
    window.document.addEventListener('stateChangeSuccess', debounce(function() {
        coyoTrackingUtils.onContentReady(function() {
            coyoClickTracking.addClickBindings();
            if (TRACKINGSETTINGS.VIDEOPLAY && TRACKINGSETTINGS.MEDIA_VIEW) coyoClickTracking.addVideoTracking();
        });
    }, 1000));

    coyoTrackingUtils.onContentReady(function() {
        coyoClickTracking.addClickBindings();
        if (TRACKINGSETTINGS.VIDEOPLAY && TRACKINGSETTINGS.MEDIA_VIEW) coyoClickTracking.addVideoTracking();
    });

    /** ######################## **/
    /* LHM Custom Overrides PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    /**
     * This file contains all customer specific adjustments in addition to the feature toggles
     */

    // this replaces the internal coyo-names by the ones, the customer wants (like german translations)
    coyoTrackingUtils.OVERRIDES = {
        // this struct is used by coyoTrackingUtils.typeNameOverrides and replaces everything in eventtracking params and custom dimensions
        TYPE: {
            'pages': 'Seiten',
            'page': 'Seite',
            'home': 'Startseite',
            'workspaces': 'Arbeitsräume',
            'arbeitsraeume': 'Arbeitsräume',
            'workspace': 'Arbeitsraum',
            'blog-article': 'Blog-Artikel',
            'wiki-article': 'Wiki-Artikel',
            'chat-message': 'Chat',
            'create': 'Erstellen',
            'timeline-item': 'Timeline-Item',
            'comment': 'Kommentieren',
            'share': 'Teilen',
            'subscribe': 'Abonnieren',
            'unsubscribe': 'Deabonnieren',
            'search': 'Suche',
            'timeline': 'Timeline',
            'filelibrary': 'Dokumente',
            'file-library': 'Dokumente',
            'content': 'Inhalt',
            'article': 'Artikel',
            // 'timeline': 'Verlauf',
            'list': 'Liste',
            'invited': 'Einladungen',
            'imprint': 'Impressum',
            // 'events': 'termine',
            'colleagues': 'Kollegen',
            'activity': 'Aktivitaeten',
            'quicksearch': 'Schnellsuche',
            'form': 'Formular',
            'task': 'Aufgaben',
            'files': 'Dateiübersicht',
            'settings': 'Einstellungen',
            'members': 'Mitglieder',
            'members-list': 'Mitglieder Liste',
            'members-invited': 'Mitglieder Einladungen',
            'members-requested': 'Mitglieder Anfragen',
            'participants': 'Teilnehmer',
            'create chatmessage': 'Nachricht senden',
            'create chatchannel': 'Chatkanal erstellen',
            'create timeline': 'Timeline Eintrag erstellen',
            'create article': 'Artikel erstellen',
            'create event': 'Event erstellen',
            'create page': 'Seite erstellen',
            'view': 'Ansicht',
            'searchresults': 'Suchergebnis',
            'no-searchresults': 'Kein Suchergebnis',
            'widget-my-pages': 'Widget-Meine-Seiten',
            'widget-my-workspaces': 'Widget-Meine-Arbeitsraeume',
            'widget-bookmarks': 'Widget-Lesezeichen',
            'search-type': 'Suche-Typ',
            'search-modified': 'Suche-Geändert',
            'search-location': 'Suche-Ort',
            'search-author': 'Suche-Autor',
            'click': 'Klick',
            'media': 'Medien',
            'navi-top': 'Hauptnavigation',
            'navi-sub': 'Unternavigation',
            'navi-mobile': 'Mobilnavigation',
            'timeline-item': 'Timeline-Eintrag',
            'gone': 'Nicht im Büro',
            'away': 'Abwesend',
            'busy': 'Beschäftigt',
            'file': 'Datei',
            'user': 'Benutzer',
            'list-entry': 'Listeneintrag',

            // 'blog-list-view': 'Blog',
            // 'wiki-list-view': 'Wiki'
        },
        //   // this struct is used by coyoTrackingUtils.typeNameOverridesPageId and replaces keywords in the actionurl / pageid
        PAGEID: {
            'pages': 'seiten',
            'page': 'seite',
            'home': 'startseite',
            'workspaces': 'ar',
            'arbeitsraeume': 'ar',
            'workspace': 'ar',
            'search': 'suche'
        },
    }

    // you can override complete functionality like this:
    // coyoTrackingUtils.translateText = function(text) { ... }

    /** ######################## **/
    /* LHM Tracking Code PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    var _paq = _paq || [];
    MATOMOSETTINGS.DOMAINS !== null ? _paq.push(['setDomains', MATOMOSETTINGS.DOMAINS]) : null;
    (function() {
        _paq.push(['setTrackerUrl', MATOMO_TARGET_PHP]);
        _paq.push(['setSiteId', MATOMO_TARGET_ID]);
        var uid = coyoTrackingUtils.getUserIdHash();
        if (uid !== '0') _paq.push(['setUserId', uid]);
        var d = document;
        var g = d.createElement('script');
        var s = d.getElementsByTagName('script')[0];
        g.type = 'text/javascript';
        g.async = true;
        g.defer = true;
        g.src = MATOMO_TARGET_JS;
        s.parentNode.insertBefore(g, s);
    })();

    // setup heartbeattimer
    if (typeof MATOMOSETTINGS.HEARTBEAT === 'number' && MATOMOSETTINGS.HEARTBEAT > 0) _paq.push(['enableHeartBeatTimer', MATOMOSETTINGS.HEARTBEAT]);


    //disable matomo defaut downloadtracking
    _paq.push(['setDownloadExtensions', ""]);

    // Element.closest() polyfill for IE
    if (!Element.prototype.matches) {
        Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
    }
    if (!Element.prototype.closest) {
        Element.prototype.closest = function(s) {
            var el = this;
            do {
                if (el.matches(s)) return el;
                el = el.parentElement || el.parentNode;
            } while (el !== null && el.nodeType === 1);
            return null;
        };
    }

    // List of tracked requests
    var coyoRequestTrackingConfig = [];
    if (TRACKINGSETTINGS.CHAT_MESSAGES) coyoRequestTrackingConfig.push({
        urlPattern: /web\/message-channels\/[0-9a-fA-F-]*\/messages$/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            sendTrackingEvent('chat-message', 'Create Chatmessage', '');
        }
    });
    if (TRACKINGSETTINGS.CHAT_CHANNELS) coyoRequestTrackingConfig.push({
        urlPattern: /web\/message-channels$/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            sendTrackingEvent('chat-channel', 'Create Chatchannel', response.type);
        }
    });
    if (TRACKINGSETTINGS.COMMENTS) coyoRequestTrackingConfig.push({
        urlPattern: /web\/comments/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            var item = coyoTrackingDBHelper.getObjectData(response.target.id);
            sendTrackingEvent(response.target.typeName, 'Comment', item.name, item);
        }
    });
    if (TRACKINGSETTINGS.SUBSCRIPTIONS) {
        coyoRequestTrackingConfig.push({
            urlPattern: /subscriptions$/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var item = coyoTrackingDBHelper.getObjectData(response.targetId);
                sendTrackingEvent(item.type, 'Subscribe', item.name, item);
            }
        });
        coyoRequestTrackingConfig.push({
            urlPattern: /subscriptions\/favorite/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var queryParams = coyoTrackingUtils.parseQueryString(responseUrl.replace(/.*\?/i, '?'));
                if (queryParams.targetId) {
                    var item = coyoTrackingDBHelper.getObjectData(queryParams.targetId);
                    sendTrackingEvent(item.type, 'Subscribe', item.name, item);
                }
            }
        });
        coyoRequestTrackingConfig.push({
            urlPattern: /subscriptions.*\?targetId=/g,
            method: 'DELETE',
            execute: function(responseUrl, response) {
                var targetMatch = (/targetId=([^\&]*)/g).exec(responseUrl);
                if (targetMatch && targetMatch.length > 1) {
                    var item = coyoTrackingDBHelper.getObjectData(targetMatch[1]);
                    sendTrackingEvent(item.type || 'unknown-type', 'Unsubscribe', item.name, item);
                }
            }
        });
    }
    if (TRACKINGSETTINGS.LIKES) {
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/like-targets\//g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var typeMatch = (/like-targets\/([\w-]*)\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                if (typeMatch && typeMatch.length > 1) {
                    var type = typeMatch[1];
                    var item = coyoTrackingDBHelper.getObjectData(typeMatch[2]);
                    var entry = item.name || coyoTrackingUtils.getPageConfig().trackingTitle || '';
                    sendTrackingEvent(type, 'Like', entry, item);
                }
            }
        });
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/like-targets\//g,
            method: 'DELETE',
            execute: function(responseUrl, response) {
                var typeMatch = (/like-targets\/([\w-]*)\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                if (typeMatch && typeMatch.length > 1) {
                    var type = typeMatch[1];
                    var item = coyoTrackingDBHelper.getObjectData(typeMatch[2]);
                    var entry = item.name || coyoTrackingUtils.getPageConfig().trackingTitle || '';
                    sendTrackingEvent(type, 'Unlike', entry, item);
                }
            }
        });
    }
    if (TRACKINGSETTINGS.CREATE_TIMELINE) coyoRequestTrackingConfig.push({
        urlPattern: /web\/timeline-items/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            var title = '';
            if (response.recipients && response.recipients.length > 0) {
                var parentType = coyoTrackingUtils.typeNameOverrides(response.recipients[0].typeName);
                var parentTitle = coyoTrackingDBHelper.buildTrackingTitle(response.recipients[0]);
                title = parentType + ' >> ' + parentTitle;
                sendTrackingEvent('timeline-item', 'Create Timeline', title, {
                    type: 'timeline-item',
                    author: response.author.slug
                });
            }
        }
    });
    if (TRACKINGSETTINGS.DELETE_TIMELINE) coyoRequestTrackingConfig.push({
        urlPattern: /web\/timeline-items/g,
        method: 'DELETE',
        execute: function(responseUrl, response) {
            var itemMatch = (/\/web\/timeline-items\/([0-9a-fA-F-]*)$/g).exec(responseUrl);
            if (itemMatch && itemMatch.length > 1) {
                var item = coyoTrackingDBHelper.getObjectData(itemMatch[1]);
                sendTrackingEvent('timeline-item', 'Delete', item.name, item);
            }
        }
    });
    if (TRACKINGSETTINGS.USER_STATUS) coyoRequestTrackingConfig.push({
        urlPattern: /web\/users\/([a-z0-9-]+)\/presence-status/g,
        method: 'PUT',
        execute: function(responseUrl, response) {
            // get presence status
            if (response.state) sendTrackingEvent(response.state.toLowerCase(), 'Change Status', '');
        }
    });
    if (TRACKINGSETTINGS.SEARCH_MAIN) coyoRequestTrackingConfig.push({
        urlPattern: /web\/search(?!.*filters=\w)/g,
        method: 'GET',
        execute: function(responseUrl, response) {
            sendSearchEvent(responseUrl, response, false)
        }
    });
    if (TRACKINGSETTINGS.SEARCH_INLINE) coyoRequestTrackingConfig.push({
        urlPattern: /web\/quick-entity-search/g,
        method: 'GET',
        execute: function(responseUrl, response) {
            //quicksearch handling: do not track every response on typing, wait some time and track the last (possible complete) term
            setTimeout(function() {
                coyoTrackingUtils._pendingSearch--;
                if (coyoTrackingUtils._pendingSearch == 0) {
                    sendSearchEvent(responseUrl, response, true);
                }
            }, 1000);
        }
    });
    if (TRACKINGSETTINGS.MEDIA_UPLOAD) coyoRequestTrackingConfig.push({
        urlPattern: /web\/senders\/.*\/documents/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            sendTrackingEvent('Media', 'Upload', response.displayName);
        }
    });
    if (TRACKINGSETTINGS.MEDIA_VIEW) {
        // document/files use nearly the same handler because different widgets and filetypes work with different requests
        // depending on which one gets executed we track the file view and coyoTrackingUtils._lastFileId prevents double tracking (also for multiple calls when opening modal)
        // examples: 
        // single-file-widget + documents panel
        //  images: first call = /files/ + /documents/, further calls just /documents/
        //  videos: first call = /files/ + /stream/, further calls nothing catchable, sometimes /stream/ based on currently streamed data
        //  other docs: first call = /files/ + further calls nothing catchable
        // media-widget:
        //  images: always /files/, nothing else
        //  videos: always /stream/ HEAD, nothing else
        // embedded video in posts:
        //  no modal, no xhr requests, so we do our own HEAD request to get the title
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/senders\/.*\/documents/g,
            method: 'GET',
            execute: function(responseUrl, response) {
                var docMatch = (/documents\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                var modal = document.querySelector('.modal-dialog');
                if (docMatch && docMatch[1] && modal) {
                    var objData = coyoTrackingDBHelper.getObjectData(docMatch[1]);
                    if (coyoTrackingUtils._lastFileId !== objData.name) sendTrackingEvent('Media', 'View', objData.name);
                    coyoTrackingUtils._lastFileId = objData.name;
                    setTimeout(function() {
                        coyoTrackingUtils._lastFileId = '';
                    }, 5000);
                }
            }
        });
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/senders\/.*\/files/g,
            method: 'GET',
            execute: function(responseUrl, response, requestData, respHeader) {
                var modal = document.querySelector('.modal-dialog');
                if (modal && response && response.displayName && response.displayName.length) {
                    // events use contentReady+Angular approach to be able to handle both: 
                    // direct file views (with id in url) 
                    // and opening modals on other pages (no fileid in url)
                    coyoTrackingUtils.onContentReady(function() {
                        if (document.querySelector('coyo-file-preview')) {
                            var filePreview = coyoTrackingUtils.getAngularComponent(document.querySelector('coyo-file-preview'));
                        }
                        if (filePreview && filePreview.file && filePreview.file.displayName) {
                            if (coyoTrackingUtils._lastFileId !== filePreview.file.displayName) sendTrackingEvent('Media', 'View', filePreview.file.displayName);
                            coyoTrackingUtils._lastFileId = filePreview.file.displayName;
                            setTimeout(function() {
                                coyoTrackingUtils._lastFileId = '';
                            }, 5000);
                        }
                    });
                }
            }
        });
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/senders\/.*\/stream/g,
            method: 'HEAD',
            execute: function(responseUrl, response, requestData, respHeader) {
                console.warn('HEAD STREAM');
                var modal = document.querySelector('.modal-dialog');
                if (modal && modal.offsetParent !== null) {
                    var docMatch = (/documents\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                    var objData = coyoTrackingDBHelper.getObjectData(docMatch[1]);
                    if (false && objData && objData.name && objData.name.length) {} else {
                        console.debug('StreamRequest: DATA ', respHeader, respHeader['content-disposition']);
                        console.debug('StreamRequest match ', respHeader['content-disposition'].match(/filename=\".*"/g));
                        var filename = respHeader['content-disposition'] && respHeader['content-disposition'].match(/filename=\".*"/g)[0].replace('filename="', '');
                        filename = filename.substr(0, filename.length - 1);
                        console.debug('StreamRequest: Header: ', respHeader);
                        console.debug('StreamRequest: filename', filename);
                        sendTrackingEvent('Media', 'View', filename, null);
                    }
                } else {
                    console.debug('VideoRequest: no modal open - ignore', document.querySelector('.modal-dialog'));
                }
            }
        });
    }
    if (TRACKINGSETTINGS.SHARE) {
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/shares\/(?!multiple)/g,
            method: 'POST',
            saveRequestData: true,
            execute: function(responseUrl, response, requestData) {
                var itemID = requestData ? requestData.itemId : '';
                var item = coyoTrackingDBHelper.getObjectData(itemID);
                sendTrackingEvent(item.type, 'Share', item.name, item);
            }
        });
        coyoRequestTrackingConfig.push({
            urlPattern: /web\/shares\/multiple\//g,
            method: 'POST',
            saveRequestData: true,
            execute: function(responseUrl, response, requestData) {
                if (!requestData) {
                    return;
                }
                for (var i = 0; i < requestData.length; i++) {
                    var itemID = requestData[i].itemId;
                    var item = coyoTrackingDBHelper.getObjectData(itemID);
                    var share = response[i];
                    if (!share || !share.recipient) {
                        continue;
                    }
                    sendTrackingEvent(item.type, 'Share', item.name, item);
                }
            }
        });
    }
    if (TRACKINGSETTINGS.CREATE_ARTICLES) coyoRequestTrackingConfig.push({
        urlPattern: /web\/.*\/(wiki|blog)\/articles/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            var parent = coyoTrackingDBHelper.getObjectData(response.senderId);
            var label = coyoTrackingUtils.typeNameOverrides(parent.type) + ' >> ' + parent.name;
            sendTrackingEvent(response.typeName, 'Create Article', label);
        }
    });
    if (TRACKINGSETTINGS.CREATE_EVENTS) coyoRequestTrackingConfig.push({
        urlPattern: /web\/events/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            sendTrackingEvent(response.event.typeName, 'Create Event', coyoTrackingDBHelper.buildTrackingTitle(response.event));
        }
    });
    if (TRACKINGSETTINGS.CREATE_PAGES) coyoRequestTrackingConfig.push({
        urlPattern: /web\/pages/g,
        method: 'POST',
        execute: function(responseUrl, response) {
            sendTrackingEvent(response.typeName, 'Create Page', coyoTrackingDBHelper.buildTrackingTitle(response));
        }
    });

    function sendTrackingEvent(targetType, action, title, checkUserItem, hasSearchResults) {
        if (coyoTrackingUtils.excludeUser(checkUserItem)) return;

        // check for platform specific type name overrides
        var pageConfig = coyoTrackingUtils.getPageConfig();
        var pageType = pageConfig.contentGroup[1] || null;
        var pageTitle = pageConfig.contentGroup[2] || null;
        var pageTitle = pageConfig.contentGroup[2] || null;
        var appType = pageConfig.contentGroup[3] || null;
        var appTitle = pageConfig.contentGroup[4] || null;
        if (ENV !== 'prod') console.log(pageConfig);
        //handle 'create' for timeline (do not track title)
        if (targetType === 'timeline-item' && action === 'Create Timeline') title = '';
        targetType = coyoTrackingUtils.typeNameOverrides(targetType);
        action = coyoTrackingUtils.typeNameOverrides(action);
        title = coyoTrackingUtils.cleanUnicodeIcons(title).text;
        coyoTrackingUtils.cleanupCustomDimensions();

        if (pageType && pageType.toLowerCase() === 'filelibrary' && TRACKINGSETTINGS.DOCUMENTTITLE_AS_CONTENT) {
            pageTitle = null;
        }

        if (pageType) {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT, coyoTrackingUtils.typeNameOverrides(pageType)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(pageType)]);
        }
        if (pageTitle) {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
        }
        // prevent tracking apptype 'Show', 
        // this happens either after a new Page/Workspace is created and there is no app setup or if redirects take longer then our debounce allows
        if (appType && appType !== 'show') {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT, coyoTrackingUtils.typeNameOverrides(appType)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(appType)]);
        }
        if (appTitle) {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT, coyoTrackingUtils.typeNameOverrides(appTitle)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(appTitle)]);
        }

        // special search handling
        if (typeof hasSearchResults === 'boolean') {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT, (hasSearchResults ? coyoTrackingUtils.typeNameOverrides('searchresults') : coyoTrackingUtils.typeNameOverrides('no-searchresults'))]);
        }
        _paq.push(['trackEvent', targetType, action, title]);
        // _paq.push(['trackEvent', targetType, action, title, null, {
        //     dimension6: pageType, 
        //     dimension7: pageTitle, 
        //     dimension8: appType,
        //     dimension9: appTitle
        // }]);
        coyoTrackingUtils.cleanupCustomDimensions();
    }

    function sendSearchEvent(responseUrl, response, isQuicksearch) {
        var pageConfig = coyoTrackingUtils.getPageConfig();
        var queryParams = coyoTrackingUtils.parseQueryString(responseUrl.replace(/.*\?/i, '?'));
        if (response && queryParams && 'object' === typeof queryParams && 'term' in queryParams && 'object' === typeof queryParams.term) {
            var pageConfig = coyoTrackingUtils.getPageConfig();
            var searchedTerm = queryParams.term.length === 1 ? decodeURIComponent(queryParams.term[0].toString()) : '';
            var rspFoundEleCount = typeof response.totalElements === 'number' ? parseInt(response.totalElements) : false;
            if (pageConfig.contentGroup[1]) {
                _paq.push(['trackSiteSearch', searchedTerm, isQuicksearch ? coyoTrackingUtils.typeNameOverrides('quicksearch') : coyoTrackingUtils.typeNameOverrides('search'), rspFoundEleCount]);
                coyoTrackingUtils.cleanupCustomDimensions();
                if (typeof isQuicksearch !== 'boolean' || !isQuicksearch) {
                    debounce(function() {
                        setTimeout(function() {
                            trackPageView(rspFoundEleCount);
                        }, MATOMOSETTINGS.DELAY_FOR_STATECHANGE || 2);
                    }, 250)();
                }
            }
        }
        return false;
    }

    function initDownloadListener() {
        // add download tracking for coyo internal files
        window.mtmDownloadListener = window.mtmDownloadListener || setInterval(function() {
            // [].slice.call for IE compatibility
            [].slice.call(document.querySelectorAll('a[coyo-download]:not(.piwik_ignore), a[href^="/web/senders/"][href*="/documents/"]:not(.piwik_ignore)')).forEach(function(elem) {
                elem.classList.add('piwik_ignore');
                if (!coyoTrackingUtils.excludeFromTracking()) {
                    elem.addEventListener('mousedown', function() {
                        function getLink(elem) {
                            var parent = elem.closest('.modal-file-details, .fl-table-row.file');
                            if (parent) {
                                var url = parent.querySelector('coyo-copy-file-link .copy-link a').dataset.clipboardText
                                var linkparts = url.split('/');
                                var filename = decodeURIComponent(linkparts[linkparts.length - 1]);
                                var lastSpace = filename.lastIndexOf(' ');
                                return {
                                    url: url,
                                    filename: filename.substr(0, lastSpace) + '.' + filename.substr(lastSpace + 1)
                                }
                            }

                            // change URL from '/web/senders/*senderID*/documents/*docID*' to '/files/*senderID*/*docID*/*docTitle*' and send it as url param
                            if (/web\/senders\/([a-z0-9-]+)\/documents\/([a-z0-9-]+)/gi.exec(elem.href)) {
                                var url = elem.href.replace('/web/senders/', '/files/').replace('/documents/', '/');
                                url = url.lastIndexOf('/') === url.length - 1 ? url : url + '/';
                                url += encodeURIComponent(elem.innerText.trim());
                                return {
                                    url: url,
                                    filename: elem.innerText.trim()
                                }
                            }

                            if (elem.getAttribute('coyo-download')) {
                                // handle download-widget (content)
                                var child = elem.firstElementChild;
                                var filename = '';
                                if (child.className === 'file-name') {
                                    filename = child.innerText.trim();
                                } else if ((parent = elem.closest('.single-file-widget-details-text')) !== null) {
                                    filename = parent.firstElementChild.innerText.trim();
                                }
                                return {
                                    url: '', // TODO: try to add get the url from somewhere, if required someday...
                                    filename: filename
                                }
                            }
                            return null;
                        }
                        var link = getLink(elem);
                        if (link.filename && link.filename.length) {
                            sendTrackingEvent('Media', 'Download', link.filename);
                            // _paq.push(['trackLink', link, 'download']);
                        }
                    });
                }
            });
        }, 500);
    }

    // debounce function to supress page views being triggered during coyo redirects
    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            // coyoTrackingUtils._initialStateChangeFired = true;
            var context = this;
            var args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };

    function trackPageView(searchResults) {
        if (coyoTrackingUtils._initialStateChangeFired) {
            if (ENV !== 'prod') console.debug('already fired. aborting');
            coyoTrackingUtils._initialStateChangeFired = false;
            return;
        }
        if (typeof coyoTrackingUtils != "object") {
            console.log("Coyo tracking utils not defined.");
            return;
        }
        var pageConfig = coyoTrackingUtils.getPageConfig();
        if (ENV !== 'prod') console.log(pageConfig);
        var pageId = coyoTrackingUtils.pageIdToString(pageConfig.contentGroup);
        var pageType = pageConfig.contentGroup[1] || null;
        var pageTitle = pageConfig.contentGroup[2] || null;
        var appType = pageConfig.contentGroup[3] || null;
        var appTitle = pageConfig.contentGroup[4] || null;
        var contentTitle = pageConfig.contentGroup[5] || null;
        if (coyoTrackingUtils.excludeFromTracking() || !pageId || pageId.indexOf(window.location.host + '..') == 0) {
            // if(ENV === 'dev'){console.log('pageview abort excluded',coyoTrackingUtils.excludeFromTracking(), pageId, pageId.indexOf(window.location.host + '..') );}
            return;
        }
        if (TRACKINGSETTINGS.MEDIA_DOWNLOAD) initDownloadListener();

        if (pageType && pageType.toLowerCase() === 'filelibrary' && TRACKINGSETTINGS.DOCUMENTTITLE_AS_CONTENT) {
            contentTitle = pageTitle;
            pageTitle = null;
        }
        coyoTrackingUtils.cleanupCustomDimensions();
        // var userCount = coyoTrackingUtils.getRegisteredUsers();
        if (!coyoTrackingUtils.excludeFromTracking(EXCLUDED_GROUPINGPATHS)) {
            if (pageType) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE, coyoTrackingUtils.typeNameOverrides(pageType)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE_VISIT, coyoTrackingUtils.typeNameOverrides(pageType)]);
            }
            if (pageTitle) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_VISIT, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
            }
            // prevent tracking apptype 'Show', 
            // this happens either after a new Page/Workspace is created and there is no app setup or if redirects take longer then our debounce allows
            if (appType && appType.toLowerCase() !== 'show') {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE, coyoTrackingUtils.typeNameOverrides(appType)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE_VISIT, coyoTrackingUtils.typeNameOverrides(appType)]);
            }
            if (appTitle) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE, coyoTrackingUtils.typeNameOverrides(appTitle)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE_VISIT, coyoTrackingUtils.typeNameOverrides(appTitle)]);
            }
            if (contentTitle) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_CONTENTTITLE, coyoTrackingUtils.typeNameOverrides(contentTitle)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_CONTENTTITLE_VISIT, coyoTrackingUtils.typeNameOverrides(contentTitle)]);
            }
        }
        _paq.push(['setReferrerUrl', coyoTrackingUtils._currentUrl]);
        coyoTrackingUtils._currentUrl = window.location.href;
        _paq.push(['setCustomUrl', coyoTrackingUtils._currentUrl]);
        _paq.push(['setDocumentTitle', pageId]);
        _paq.push(['setGenerationTimeMs', 0]);

        if (pageType === 'search') {
            if (typeof searchResults !== 'undefined') {
                if (searchResults > 0) {
                    _paq.push(['setDocumentTitle', pageId + '.suchergebnis']);
                    _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE, coyoTrackingUtils.typeNameOverrides('searchresults')]);
                } else {
                    _paq.push(['setDocumentTitle', pageId + '.kein-suchergebnis']);
                    _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE, coyoTrackingUtils.typeNameOverrides('no-searchresults')]);
                }
            } else {
                // if(ENV === 'dev'){console.log('pageview abort search',searchResults);}
                return
            }
        }

        if (MATOMOSETTINGS.CONTENT_NODE && MATOMOSETTINGS.CONTENT_NODE.length) {
            var content = document.querySelector(MATOMOSETTINGS.CONTENT_NODE);
            if (content) {
                if (MATOMOSETTINGS.CONTENT_SCAN_FOR_MEDIA)
                    _paq.push(['MediaAnalytics::scanForMedia', content]);
                if (MATOMOSETTINGS.CONTENT_SCAN_FOR_FORMS)
                    _paq.push(['FormAnalytics::scanForForms', content]);
                if (MATOMOSETTINGS.CONTENT_TRACKING_MODE === 'node')
                    _paq.push(['trackContentImpressionsWithinNode', content]);
                else if (MATOMOSETTINGS.CONTENTTRACKING_MODE === 'delay')
                    _paq.push(['trackVisibleContentImpressions', true, MATOMOSETTINGS.CONTENT_REFRESHDELAY || 750]);
            }
        }
        if (MATOMOSETTINGS.MIDDLERIGHT_MOUSECLICK) {
            _paq.push(["enableLinkTracking", true]);
        } else {
            _paq.push(["enableLinkTracking"]);
        }
        if (ENV !== 'prod') {
            console.debug('pageview sending', pageConfig);
        }
        _paq.push(['trackPageView']);
        coyoTrackingUtils.cleanupCustomDimensions();
        // if(ENV === 'dev'){console.log('pageview done');}
    }

    // page view tracking
    window.document.addEventListener('stateChangeSuccess', debounce(function() {
        if (ENV !== 'prod') {
            console.debug('stateChangeSuccess event');
        }
        // wait until content is ready
        coyoTrackingUtils.onContentReady(function() {
            trackPageView();
        });
    }, 1000), false);

    // heartbeat hack: ping on change, just ping immediately, do not wait for pagecall
    window.document.addEventListener('stateChangeSuccess', function() {
        _paq.push(['ping']);
    });

    // request event tracking
    var openPrototypeTracking = XMLHttpRequest.prototype.open;
    var sendPrototypeTracking = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function() {
        var method = arguments[0];
        var reqURL = arguments[1];
        var that = this;
        coyoTrackingUtils._openRequests++;
        // if(ENV !== 'prod') console.debug(coyoTrackingUtils._openRequests);
        // special case for getting request data from send() method
        coyoRequestTrackingConfig.forEach(function(item) {
            if (method == item.method && reqURL && reqURL.match(item.urlPattern) && item.saveRequestData) {
                that.saveRequestData = true;
            }
        });

        //quicksearch handling: do not track every response on typing, wait some time and track the last (possible complete) term 
        if (reqURL.match(/web\/quick-entity-search/g)) {
            coyoTrackingUtils._pendingSearch++;
        }

        this.addEventListener('load', function(e) {
            coyoTrackingUtils._openRequests--;
            // if(ENV !== 'prod') console.debug(coyoTrackingUtils._openRequests);
            if (coyoTrackingUtils.excludeFromTracking()) {
                return;
            }
            var resp = {};
            var rspPayload = null;
            var reqQueryParams = null;
            resp.responseType = this.responseType;
            resp.responseURL = this.responseURL || reqURL;
            resp.requestData = this.requestData;
            resp.headers = {};
            resp.headers = coyoTrackingUtils.getResponseHeaders(that);
            try {
                resp.responseText = this.responseText;

                rspPayload = e.currentTarget.responseText.length > 0 ? JSON.parse(e.currentTarget.responseText) : null;
                reqQueryParams = coyoTrackingUtils.parseQueryString(reqURL.replace(/.*\?/i, '?'));
            } catch (e) {}
            setTimeout(function() {
                if (typeof coyoTrackingDBHelper == 'undefined') {
                    console.log('Coyo tracking name data base not defined.');
                    return;
                }

                var response;
                try {
                    if ((resp.responseType == '' || resp.responseType == 'text' || resp.responseType == 'document' || resp.responseType == 'moz-chunked-text') && resp.responseText) {
                        response = eval("(" + resp.responseText + ")");
                    }
                } catch (e) {}

                // check all defined listener
                coyoRequestTrackingConfig.forEach(function(item) {
                    if (method == item.method && resp.responseURL.match(item.urlPattern) && typeof item.execute == 'function') {
                        item.execute(resp.responseURL, response, resp.requestData, resp.headers);
                        return;
                    }
                });
            });
        }, 2);
        openPrototypeTracking.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function() {
        try {
            if (arguments && arguments[0] && this.saveRequestData) {
                this.requestData = JSON.parse(arguments[0]);
            }
        } catch (e) {}

        sendPrototypeTracking.apply(this, arguments);
    };

    // fix for using this script with matomo tag manager / container:
    // the container will be loaded async, this results in 2 cases
    // a) the container with this code finished loading BEFORE the app finishes with a stateChangeSuccess -> everything works normal, initial pagewview is catched by the event
    // b) AFTER that -> we missed the first stateChangeSuccess and therefore have to trigger it manually
    if (TRACKINGSETTINGS.USE_TAGMANAGER) {
        coyoTrackingUtils.onContentReady(function() {
            if (ENV !== 'prod') console.debug('initial?', coyoTrackingUtils._initialStateChangeFired);
            if (!coyoTrackingUtils._initialStateChangeFired) {
                if (ENV !== 'prod') {
                    console.debug('initial page call');
                }
                trackPageView();
                coyoTrackingUtils._initialStateChangeFired = true;
            }
        });
    }

    /** ######################## **/
    /* LHM Custom Code PROD
    /* T-Systems MMS
    /* Version: 1.0.6
    /* Updated: 2020-07-15
    /** ######################## **/

    /**
     * This file contains custom code not related to tracking
     * It's used to change UI and its behavior
     * it's packed and attached at the end of our build
     */
</script>
